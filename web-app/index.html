<!doctype html>
<html lang="fr">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./node_modules/@fortawesome/fontawesome-free/css/fontawesome.min.css">
    <link rel="stylesheet" href="./node_modules/@fortawesome/fontawesome-free/css/solid.css">

    <link rel="manifest" href="./manifest.json">
    <title>Explord</title>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Explord</a>
        <button id="connect" class="btn btn-primary" onclick="connect_device()">Se connecter à un capteur</button>
    </nav>

    <div class="containe-fluid m-2">
        <div id="error-message" class="p-3 mb-2 bg-danger text-white" style="display:none"></div>
        <div id="devices-container" class="bg-dark text-white">
    </div>

    <script src="./node_modules/jquery/dist/jquery.slim.min.js"></script>
    <script src="./node_modules/popper.js/dist/umd/popper.min.js"></script>
    <script src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    <script src="./node_modules/moment/moment.js"></script>
    <script src="./node_modules/chart.js/dist/Chart.js"></script>

   <script>

        const _characteristics = {
            "2a6e" : {
                name : "Température",
                short : "temperature",
                unit: "°C",
                min: 0,
                max: 65,
                nb_bit: "Int16"
            },
            "2a7b" : {
                name : "Point de rosée",
                short : "dew",
                unit: "°C",
                min: 0,
                max: 65,
                nb_bit: "Int16"
            },
            "2a7a" : {
                name : "Indice de chaleur",
                short : "heat_index",
                unit: "°C",
                min: 0,
                max: 65,
                nb_bit: "Int16"
            },
            "2a6f" : {
                name : "Humidité",
                short : "humidity",
                unit: "%",
                min: 0,
                max: 100,
                nb_bit: "Uint16"
            },
            "486a" : {
                name : "Dioxygène",
                short : "o2_rate",
                unit: "%",
                min: 0,
                max: 25,
                nb_bit: "Uint16"
            },
            "486b" : {
                name : "Pression partielle en O2",
                short : "ppo2",
                unit: "Pa",
                min: 0,
                max: 1100000,
                nb_bit: "Uint32"
            },
            "2a6d" : {
                name : "Pression",
                short : "pressure",
                unit: "Pa",
                min: 0,
                max: 1100000,
                nb_bit: "Uint32"
            },
            "486c" : {
                name : "Dioxyde de carbone",
                short : "co2_rate",
                unit: "ppm",
                min: 0,
                max: 50000,
                nb_bit: "Uint16"
            },
            "2afb" : {
                name : "Luminosité",
                short : "luminosity",
                unit: "lux",
                min: 0,
                max: 50000,
                nb_bit: "Uint16"
            }
        };


// const BLEUUID MultiConnectStateUUID = BLEUUID("00004870-1000-2000-3000-6578706c6f72");
// const BLEUUID SerialStateUUID = BLEUUID("00004871-1000-2000-3000-6578706c6f72");
// const BLEUUID LogStateUUID = BLEUUID("00004872-1000-2000-3000-6578706c6f72");
        const _characteristics_parameters = {
            "00004861-1000-2000-3000-6578706c6f72" : {
                name : "Delay",
                short : "delay",
                nb_bit: "Uint32",
                type: "numeric",
                input: "text"
            },
            "00004871-1000-2000-3000-6578706c6f72" : {
                name : "Serial",
                short : "serial",
                nb_bit: "Uint8",
                type: "boolean",
                input: "checkbox"
            },
            "00004870-1000-2000-3000-6578706c6f72" : {
                name : "Multiconnect",
                short : "multiconnect",
                nb_bit: "Uint8",
                type: "boolean",
                input: "checkbox"
            },
            "00004872-1000-2000-3000-6578706c6f72" : {
                name : "Log",
                short : "logstate",
                nb_bit: "Uint8",
                type: "boolean",
                input: "checkbox"
            }

        }
        // Unuse : generate bug with android (no devices detected)
        // const customServiceUuid = "00004860-1000-2000-3000-6578706c6f72";

        let _devices = [];
        let _charts = {};
        let _services = [];

        let _log_state = false;
        let _log_value = {};
        let _interval_id;
        let log_interval = 1000;

        function connect_device() {
          console.log("connecting ...");
          let deviceId;
          navigator.bluetooth.requestDevice(
                // filters devices with environmental_sensing only
                //     Add custom services block devices detection on android
                {filters: [{ services: ['environmental_sensing'] }] }
            ).then(
            device => {
                _devices.push({"device" : device, "charts":{}, "current_value":{}});
                deviceId = _devices.length - 1;
                connectDevice(deviceId, device.name)
                return device.gatt.connect();
            }
          ).then(server => {
            // Note that we could also get all services that match a specific UUID by
            // passing it to getPrimaryServices().
            console.log('Getting Services...');
            return server.getPrimaryServices();
        }).then(services => {
            console.log('Getting Characteristics...');
            let queue = Promise.resolve();
            services.forEach(service => {
            queue = queue.then(_ => service.getCharacteristics().then(characteristics => {
                console.log('  > Service: ' + service.uuid);
                characteristics.forEach(characteristic => {
                    // console.log(characteristic.uuid);
                    let uuid = characteristic.uuid.slice(4,8);
                    if (_characteristics[uuid]) {
                        addCharacteristicContainer(uuid, deviceId);
                        getCharacteristicValue(characteristic, uuid, deviceId);
                    }
                    else if (_characteristics_parameters[characteristic.uuid]) {
                        if (_devices[deviceId]["parameters"] == undefined) {
                            _devices[deviceId]["parameters"] = [];
                        }
                        _devices[deviceId]["parameters"][characteristic.uuid] = characteristic;
                        addCharacteristicParametersContainer(characteristic.uuid, deviceId);
                        getCharacteristicParametersValue(characteristic, characteristic.uuid, deviceId);
                    }
                });
            }));
            });
            return queue;
        }).catch(
              error => {
                    console.log(error.message);
                    let errdiv = document.querySelector('#error-message')
                    errdiv.style.display = "";
                    errdiv.textContent = error.message;

                }
              );
        }

        function connectDevice(id, name) {
            let container = document.querySelector('#devices-container');
            let div = document.createElement('div');
            div.innerHTML = `
            <div id="device-${id}">
                <div class="card bg-dark text-white">
                    <div class="card-header" id="heading_device-${id}">
                        <h5 class="mb-0">

                        <i id="icon-parameters-${id}" class="fas fa-cogs" data-toggle="collapse"
                            data-target="#collapse_parameters-${id}" aria-expanded="true"
                            aria-controls="collapse_parameters-${id}"></i>
                        <button class="btn btn-link text-white" data-toggle="collapse"
                            data-target="#collapse_device-${id}" aria-expanded="true"
                            aria-controls="collapse_device-${id}"
                        >
                            ${name}
                        </button>
                        <button class="btn btn-danger float-right" onclick="onDisconnectButtonClick(${id})">Se déconnecter</button>
                        </h5>
                    </div>
                    <div id="collapse_parameters-${id}" class="collapse">
                        <div class="border-bottom pb-2 m-2" id="parameters_device-${id}">
                            <h5>Paramètres</h5>
                            <div id="parameters_list_${id}" class="p-2"></div>
                            <button class="btn btn-primary" onclick="configureParameters(${id})">Configurer</button>
                        </div>
                    </div>
                    <div id="collapse_device-${id}" class="collapse show">
                        <div class="card-body">
                            <div class="form-inline">
                                <div class="form-group mt-2">
                                    <label for="delay_${id}" class="ml-2">Intervalle: </label>
                                    <select id="delay_${id}" onchange="log_delay(${id})" class="form-control m-2">
                                        <option value="1" default>1 s</option>
                                        <option value="5">5 s</option>
                                        <option value="10">10 s</option>
                                        <option value="30">30 s</option>
                                        <option value="60">60 s</option>
                                    </select>
                                    <div class="form-group ml-2">
                                        <label for="graph_nb_val_${id}" class="ml-2">Nombre de valeurs sur le graphique: </label>
                                        <input id="graph_nb_val_${id}" type="text" class="form-control ml-1" style="width: 5em;" onchange="log_delay(${id})" value="100"></input>
                                    </div>
                                    <div class="form-group ml-2">
                                        <button id="log-data_${id}" class="btn btn-info" onclick="log_data(${id})">Enregistrer</button>
                                    </div>
                                    <div class="form-group ml-2">
                                        <a id="export-csv_${id}" class="btn btn-success" style="display: none;" href='#' onclick='downloadCSV({deviceId: ${id}, filename: "sensor-data.csv" });'><i class="fas fa-file-csv"></i> Exporter</a>
                                    </div>
                                </div>
                            </div>
                            <hr/>
                            </div>
                            <div id="value_list_${id}" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            container.appendChild(div);
        }

        function onDisconnectButtonClick(id) {
            let bluetoothDevice = _devices[id].device;
            if (!bluetoothDevice) {
                return;
            }
            if (bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                clearInterval(_interval_id);
                document.querySelector('#device-'+id).remove();
                Object.keys(_devices[id]["charts"]).forEach(function(key) {
                    _devices[id]["charts"][key].destroy();
                });
                _devices.splice(id, id+1);
            } else {
                console.log('> Bluetooth Device is already disconnected');
            }
        }

        function onDisconnected(event) {
            let device = event.target;
            console.log('Device ' + device.name + ' is disconnected.');
        }

        function addCharacteristicContainer(uuid, deviceId) {
            let container = document.querySelector('#value_list_'+deviceId);
            let div = document.createElement('div');
            let id_carac = _characteristics[uuid].short;
            div.className = "p-4 col-sm-12 col-md-6 ";
            div.innerHTML +=  `
            <h5>
                ${_characteristics[uuid].name} :
                <span id="value_${deviceId}_${id_carac}"></span>${_characteristics[uuid].unit}
                <i
                    class="btn-collapse_${deviceId} fas fa-chart-line" style="display: none;"
                    data-toggle="collapse" data-target="#collapse_${deviceId}_${id_carac}"
                    aria-expanded="false" aria-controls="collapse_${deviceId}_${id_carac}">
                </i>
            </h5>
            <div class="collapse graph-collapse_${deviceId}" id="collapse_${deviceId}_${id_carac}">
                <div class="card card-body">
                    <div style="md-12">
                            <canvas id="chart_${deviceId}_${id_carac}"></canvas>
                    </div>
                </div>
            </div>`;
            container.appendChild(div);
            generateGraph(uuid, deviceId);
        }

        function getCharacteristicValue(characteristic, uuid, deviceId) {
            return characteristic.startNotifications()
            .then(
                characteristic => {
                characteristic.addEventListener(
                    'characteristicvaluechanged',
                    function (event) {handleCharacteristicValueChange(event, deviceId)}
                );
                return characteristic.readValue();
                }
            ).catch(error => { console.log(error); });
        }

        function handleCharacteristicValueChange(event, deviceId) {
            let carac_code = event.target.uuid.slice(4,8);

            value = parseValue(event.target.value, _characteristics[carac_code].nb_bit, 100);

            const characValueContainer = document.querySelector(
              '#value_' + deviceId + '_' + _characteristics[carac_code].short
            )

            // Display value
            if (characValueContainer){
              characValueContainer.innerHTML = value;
            }

            // Store value
            _devices[deviceId]["current_value"][carac_code] = value;
        }

        function handleCharacteristicParametersValueChange(event, deviceId) {
            console.log("handleCharacteristicParametersValueChange");
            let carac_code = event.target.uuid;
            const charac = _characteristics_parameters[carac_code];
            value = parseValue(event.target.value, charac.nb_bit);
            const characValueContainer = document.querySelector(
              '#value_parameters_' + deviceId + '_' + charac.short
            )
            // Display value
            if (characValueContainer){
                if (charac.input == "checkbox") {
                    characValueContainer.checked = value;
                }
                else {
                    characValueContainer.value = value;
                }
            }
        }

        function addCharacteristicParametersContainer(uuid, deviceId) {
            let container = document.querySelector('#parameters_list_'+deviceId);
            let div = document.createElement('div');
            let id_carac = _characteristics_parameters[uuid].short;
            div.className = "pt-2";
            div.innerHTML =
                "<div>" +
                _characteristics_parameters[uuid].name +
                " : <input type='" + _characteristics_parameters[uuid].input +
                "' id=value_parameters_" + deviceId + "_" + id_carac +
                "></input></div>";
            container.appendChild(div);
        }

        function getCharacteristicParametersValue(characteristic, uuid, deviceId) {
            return characteristic.startNotifications()
            .then(
                characteristic => {
                characteristic.addEventListener(
                    'characteristicvaluechanged',
                    function (event) {handleCharacteristicParametersValueChange(event, deviceId) }
                );
                return characteristic.readValue();
                }
            ).catch(
                error => {
                     console.log(error);
                }
            );
        }

        function parseValue(value, type, divide=1) {
          value = value.buffer ? value : new DataView(value);
          let result;

          if (type == 'Uint8')  {
              result = value.getUint8(0, /*littleEndian=*/true) / divide;
          }
          else if (type == 'Int8')  {
              result = value.getInt8(0, /*littleEndian=*/true) / divide;
          }
          else if (type == 'Uint16') {
              result = value.getUint16(0, /*littleEndian=*/true) / divide;
          }
          else if (type == 'Int16')  {
              result = value.getInt16(0, /*littleEndian=*/true) / divide;
          }
          else if (type == 'Int32')  {
              result = value.getInt32(0, /*littleEndian=*/true) / divide;
          }
          else if (type == 'Uint32')  {
              result = value.getUint32(0, /*littleEndian=*/true) / divide;
          }

          return result;
        }

        function formatValue(value, type) {
          let result;
          if (type == 'Uint8') {
              result = Uint8Array.of(value, /*littleEndian=*/true);
          }
          else if (type == 'Uint32')  {
              result = Uint32Array.of(value, /*littleEndian=*/true);
          }
          else if (type == 'Int16')  {
              result = Int16Array.of(value, /*littleEndian=*/true);
          }
          else if (type == 'Int32')  {
              result = Int32Array.of(value, /*littleEndian=*/true);
          }
          return result;
        }

        function configureParameters(deviceId){
            Object.entries(_devices[deviceId]["parameters"]).forEach(
                ([uuid, charac]) => writeOnService(deviceId, uuid,charac)
            );
        }

        function writeOnService(deviceId, uuid, characteristic) {
            let paramInput = document.querySelector("#value_parameters_" + deviceId + "_" + _characteristics_parameters[uuid].short)
            let paramValue;
            if ( _characteristics_parameters[uuid].input == "checkbox") {
                paramValue = paramInput.checked ? 1 : 0 ;
            }
            else {
                paramValue = paramInput.value;
            }
            // si aucune valeur définie la valeur n'est pas envoyée
            if (!paramValue) return;

            var newParamValue = formatValue(paramValue,_characteristics_parameters[uuid].nb_bit);
            characteristic.writeValue(newParamValue)
            .then(_ => {
                console.log('OK paramters send to device');
            })
            .catch(error => { console.log(error); })
        }

        //Logging
        function log_delay(deviceId){
            if (_log_state== true) {
                clearInterval(_interval_id);
                log_interval = parseInt(document.querySelector("#delay_"+deviceId).value);
                _interval_id = setInterval(function() {storeValue(deviceId)}, log_interval*1000);
            }
        }

        function log_data(deviceId) {
            if (_log_state == false) {

            // -- If there is some data clear graph
            if (((_log_value[0] || [])["time"] || []).length > 0) {
                if (confirm('Il y a déjà des données, elles seront supprimée. Etes vous sur de vouloir relancer un enregistrement?')) {
                    _log_value[deviceId] = [];
                    clearGraphValues(deviceId);
                } else {
                    return;
                }
            }


                _log_state = true;

                // ---- Init graphs : activate display graph
                if (!$(".btn-collapse_" + deviceId).is(":visible")) {
                    $(".btn-collapse_" + deviceId).show();
                    $(".graph-collapse_" + deviceId).collapse("show")
                }
                log_delay(deviceId);

                document.querySelector("#log-data_"+deviceId).innerHTML = "Stop";
                document.querySelector("#log-data_"+deviceId).classList.remove("btn-info");
                document.querySelector("#log-data_"+deviceId).classList.add("btn-warning");
            }
            else {
                clearInterval(_interval_id);
                _log_state = false;
                document.querySelector("#log-data_"+deviceId).innerHTML = "Enregistrer";
                document.querySelector("#log-data_"+deviceId).classList.remove("btn-warning");
                document.querySelector("#log-data_"+deviceId).classList.add("btn-info");
            }
            //Affichage bouton exporter
            showHtmlElement(document.querySelector("#export-csv_"+deviceId));
        }

        function storeValue(deviceId) {
            log = _log_value[deviceId] || [];
            log['time'] = log['time'] || [];
            log['time'].push(Date());
            for(var index in _characteristics) {
                if (_devices[deviceId]["current_value"][index]) {
                    log[index] = log[index] || [];
                    log[index].push(_devices[deviceId]["current_value"][index]);
                }
            }
            _log_value[deviceId] = log;

            // Refresh graph
            refreshGraphValues(deviceId);
        }

        //------------------------------CSV
        function generateCsv(deviceId) {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "time," + Object.keys(_devices[deviceId].current_value).map( k =>
                    _characteristics[k]["short"]
                ).join(',') + "\n";
            for(var i in _log_value[deviceId]['time']) {
                time = _log_value[deviceId]['time'][i];

                csvContent += formatTime(time) +',';
                csvContent += Object.keys(_devices[deviceId].current_value).map( k =>
                    _log_value[deviceId][k][i]
                ).join(',')
                csvContent += "\n";
            }
            return csvContent;
        }

        function formatTime(time) {
          if (typeof(time) == "string") {
            time = new Date(time);
          }
          return time.getHours() + ':' + time.getMinutes() + ':' + time.getSeconds();
        }

        function downloadCSV(args) {
            var csv = generateCsv(args.deviceId);
            data = encodeURI(csv);

            link = document.createElement('a');
            link.setAttribute('href', data);
            link.setAttribute('download', args.filename);
            link.click();
        }

        //-------------------------Graph
        function generateGraph(uuid, deviceId) {

            let carac = _characteristics[uuid];

            let ctx = document.getElementById(
                `chart_${deviceId}_${carac.short}`
            ).getContext('2d');
            let chart = new Chart(ctx,{
                type: 'line',
                data: {
                    datasets: [{
                        label: carac.name,
                        backgroundColor: Chart.helpers.color('rgb(54, 162, 235)').alpha(0.5).rgbString(),
                        // borderColor: 'rgb(54, 162, 235)',
                        fill: false,
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                                    type: 'time',
                                    time: {
                                        unit: 'second',
                                        displayFormats: {
                                            second: 'h:mm:ss'
                                        }
                                    }
                                }],
                        yAxes: [{
                            ticks: {
                                min: carac.min,
                                max: carac.max,
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
            _devices[deviceId]["charts"][uuid] = chart;
        }

        function refreshGraphValues(deviceId) {
            let device = _devices[deviceId];
            let charts = device["charts"];

            if (charts == "undefined") return;

            Object.keys(charts).forEach(characCode =>
                refreshGraphCaracValues(deviceId, characCode)
            );

        }

        function refreshGraphCaracValues(deviceId, characCode) {
            let device = _devices[deviceId];

            let charts = device["charts"][characCode];

            charts.data.datasets.forEach(function(dataset) {
                if (dataset.data.length == 0) {
                    dataset.data = initGraphSeries(deviceId, _devices[deviceId]["current_value"][characCode]);
                }
                else {
                    dataset.data.push({
                        x: new Date(),
                        y: _devices[deviceId]["current_value"][characCode]
                    });
                }
            });

            // Si nb d'éléments trop important suppression
            // des premières valeurs
            const durationOfSerie = parseInt(document.querySelector("#graph_nb_val_"+deviceId).value);
            charts.data.datasets.forEach((dataset) => {
                if (dataset.data.length > durationOfSerie) {
                    let nb_to_del = dataset.data.length - durationOfSerie;
                    dataset.data.splice(0, nb_to_del);
                }
            });

            charts.update();
        }

        function initGraphSeries(deviceId, firstValue) {
            // Générate label series
            let delay = parseInt(document.querySelector("#delay_"+deviceId).value);
            let durationOfSerie = parseInt(document.querySelector("#graph_nb_val_"+deviceId).value);

            let initlabels = [{x: new Date(), y: firstValue}]
            for (let i = 1; i < durationOfSerie/delay; i++) {
                const previousDate = initlabels[i-1].x;
                const newDate = new Date(previousDate.setSeconds(previousDate.getSeconds() + delay ));
                initlabels.push( {
                    x: newDate
                });
            }
            return initlabels;
        }

        function clearGraphValues(deviceId) {
            let device = _devices[deviceId];
            let charts = device["charts"];

            if (charts == "undefined") return;

            Object.keys(charts).forEach(characCode =>{
                chart = device["charts"][characCode]
                chart.data.datasets.forEach((dataset) => {
                    dataset.data.splice(0, dataset.data.length);
                });
            });
        }

        //-------------------------Services worker
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('Registered:', registration);
          })
          .catch(function(error) {
            console.log('Registration failed: ', error);
          });
        }

        function showHtmlElement(el){
            if (el.style.display == "none") {
                el.style.display ="block";
            }
        }
    </script>
  </body>
</html>
